"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var t=require("./Api/index.js"),e=require("./utils.js");const r="get_status",n="get_segmentation",i="get_template",s="get_service_sector",a="get_attendant",o="get_contact",c="get_prot",u="put_contact",l="set_contact",d="open_followup",h="send_text",p="send_image",f="send_file",g="send_sound";exports.default=class Maxbot{constructor(t){return this.config={token:"",timeout:3e3,baseURL:"https://mbr.maxbot.com.br/api/v1.php"},this.ready=!1,this.cancelSources=[],this.allowedExt={file:["pdf","doc","docx","xls","xlsx","ppt","pptx","pps"],image:["jpg","jpeg","png","gif"],sound:["mp3"]},this.setMe(t),this}addError(t){return{status:0,msg:t}}isValidExt(t,r=""){const n=e.replaceAll(t,".","");if(!r){return Object.keys(this.allowedExt).reduce(((t,e)=>(this.allowedExt[e].forEach((e=>t.push(e))),t)),[]).includes(e.replaceAll(n,".",""))}return!!this.allowedExt[r].includes(e.replaceAll(n,".",""))}async isReady(t){if(!this.config.token)return!1;return!t&&this.ready||(this.ready=await(async()=>{const t=await this.getStatus();return!!parseInt(t.status,10)})()),!!this.ready}setMe(t,e){const{config:r}=this;if("object"==typeof t){const e=Object.keys(t);for(let n=0;n<e.length;n++)e[n]in r&&(r[e[n]]=t[e[n]])}else"string"==typeof t&&t in r&&(r[t]="function"==typeof e?e():e);return this}getMe(){return this.config}async getStatus(){return await this.requestApi(r)}async getSegmentation(){return await this.requestApi(n)}async getTemplate(){return await this.requestApi(i)}async getServiceSector(){return await this.requestApi(s)}async getAttendant(){return await this.requestApi(a)}async getContact(t){return await this.requestApi(o,t)}async getProt(t){return await this.requestApi(c,t)}async putContact(t){return await this.requestApi(u,t)}async setContact(t){return await this.requestApi(l,t)}async openFollowup(t){return await this.requestApi(d,t)}async sendText(t,r){const n=e.prepareSendFilter(t);if(!n)return!1;const i={...n,msg:r};return await this.requestApi(h,i)}async sendImage(t,r){const n=e.prepareSendFilter(t);if(!n)return this.addError("internal: no contact");if(!e.isValidURL(r))return this.addError("internal: invalid url");const i=e.extractExtension(r);if(!this.isValidExt(i,"image"))return this.addError("internal: invalid extension "+i);const s={...n,imageUrl:r,imageExtension:i};return await this.requestApi(p,s)}async sendFile(t,r){const n=e.prepareSendFilter(t);if(!n)return this.addError("internal: no contact");if(!e.isValidURL(r))return this.addError("internal: invalid url");const i=e.extractExtension(r);if(!this.isValidExt(i,"file"))return this.addError("internal: invalid extension "+i);const s={...n,fileUrl:r,fileExtension:i};return await this.requestApi(f,s)}async sendSound(t,r){const n=e.prepareSendFilter(t);if(!n)return this.addError("internal: no contact");if(!e.isValidURL(r))return this.addError("internal: invalid url");const i=e.extractExtension(r);if(!this.isValidExt(i,"sound"))return this.addError("internal: invalid extension "+i);const s={...n,soundUrl:r,soundExtension:i};return await this.requestApi(g,s)}async requestApi(e,r={}){const n=this,i=t.getCancelToken().source(),s=i.token;this.addCancelSource(i);const a=await t.default.post(null,{cmd:e,token:n.config.token,...r},{timeout:n.config.timeout,baseURL:n.config.baseURL,cancelToken:s});return a&&a.status&&(this.ready=!0),this.removeCancelSource(s),a}addCancelSource(t){return this.cancelSources.push({idToken:t.token,source:t}),this}removeCancelSource(t){if(t){const e=this.cancelSources.filter((({idToken:e})=>e!==t));return this.cancelSources=e||[],this}return this.cancelSources=[],this}cancel(){return this.cancelSources.forEach((({source:t})=>t&&t.cancel())),this.removeCancelSource(),this}};

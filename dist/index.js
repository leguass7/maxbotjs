"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("axios"),t=require("camelcase-keys"),r=require("./api/onResponseError.js"),s=require("./utils.js"),i=require("./decamelcase.js");function _interopDefaultLegacy(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var n=_interopDefaultLegacy(e),a=_interopDefaultLegacy(t);const o="get_status",c="get_segmentation",u="get_template",l="get_service_sector",d="get_attendant",h="get_contact",p="get_prot",g="put_contact",f="set_contact",x="open_followup",y="send_text",E="send_image",m="send_file",A="send_sound";exports.default=class Maxbot{constructor(e){return this.config={token:"",timeout:3e3,baseURL:"https://mbr.maxbot.com.br/api/v1.php",debug:!1},this.ready=!1,this.loggingPrefix="MaxbotJs",this.version="0.1.0",this.Api=n.default.create(),this.cancelSources=[],this.allowedExt={file:["pdf","doc","docx","xls","xlsx","ppt","pptx","pps"],image:["jpg","jpeg","png","gif"],sound:["mp3"]},this.setMe(e).configureAxios()}log(...e){this.config.debug&&console.log(this.loggingPrefix,...e,"\n")}getCancelToken(){return n.default.CancelToken}configureAxios(){return this.Api=n.default.create({baseURL:this.config.baseURL}),this.configureRequests().configureResponses()}configureRequests(){return this.Api.interceptors.request.use((e=>(e.headers["user-agent"]=`maxbotjs/${this.version} (+https://github.com/leguass7/maxbotjs.git)`,e.data=i.default(e.data),this.log("REQUEST:",e.data),e))),this}configureResponses(){return this.Api.interceptors.response.use((e=>(this.log("RESPONSE:",e.data||e),a.default(e.data,{deep:!0}))),r.onResponseError),this}addError(e){return{status:0,msg:e}}isValidExt(e,t=""){const r=s.replaceAll(e,".","");if(!t){return Object.keys(this.allowedExt).reduce(((e,t)=>(this.allowedExt[t].forEach((t=>e.push(t))),e)),[]).includes(s.replaceAll(r,".",""))}return!!this.allowedExt[t].includes(s.replaceAll(r,".",""))}async isReady(e=!1){if(!this.config.token)return!1;return!e&&this.ready||(this.ready=await(async()=>{try{const e=await this.getStatus();return!(!e||!e.status)}catch(e){return!1}})()),!!this.ready}setMe(e,t){const{config:r}=this;if("object"==typeof e){const t=Object.keys(e);for(let s=0;s<t.length;s++)t[s]in r&&(r[t[s]]=e[t[s]])}else"string"==typeof e&&e in r&&(r[e]="function"==typeof t?t():t);return this}getMe(){return this.config}async getStatus(){return await this.requestApi(o)}async getSegmentation(){return await this.requestApi(c)}async getTemplate(){return await this.requestApi(u)}async getServiceSector(){return await this.requestApi(l)}async getAttendant(){return await this.requestApi(d)}async getContact(e){return await this.requestApi(h,e)}async getProt(e){return await this.requestApi(p,e)}async putContact(e){return await this.requestApi(g,e)}async setContact(e){return await this.requestApi(f,e)}async openFollowup(e){return await this.requestApi(x,e)}async sendText(e,t){const r=s.prepareSendFilter(e);if(!r)return!1;const i={...r,msg:t};return await this.requestApi(y,i)}async sendImage(e,t){const r=s.prepareSendFilter(e);if(!r)return this.addError("internal: no contact");if(!s.isValidURL(t))return this.addError("internal: invalid url");const i=s.extractExtension(t);if(!this.isValidExt(i,"image"))return this.addError("internal: invalid extension "+i);const n={...r,imageUrl:t,imageExtension:i};return await this.requestApi(E,n)}async sendFile(e,t){const r=s.prepareSendFilter(e);if(!r)return this.addError("internal: no contact");if(!s.isValidURL(t))return this.addError("internal: invalid url");const i=s.extractExtension(t);if(!this.isValidExt(i,"file"))return this.addError("internal: invalid extension "+i);const n={...r,fileUrl:t,fileExtension:i};return await this.requestApi(m,n)}async sendSound(e,t){const r=s.prepareSendFilter(e);if(!r)return this.addError("internal: no contact");if(!s.isValidURL(t))return this.addError("internal: invalid url");const i=s.extractExtension(t);if(!this.isValidExt(i,"sound"))return this.addError("internal: invalid extension "+i);const n={...r,soundUrl:t,soundExtension:i};return await this.requestApi(A,n)}async requestApi(e,t={}){const r=this.getCancelToken().source(),s=r.token;this.addCancelSource(r);const i=await this.Api.post(null,{cmd:e,token:this.config.token,...t},{timeout:this.config.timeout,cancelToken:s});return this.removeCancelSource(s),i}addCancelSource(e){return this.cancelSources.push({idToken:e.token,source:e}),this}removeCancelSource(e){if(e){const t=this.cancelSources.filter((({idToken:t})=>t!==e));return this.cancelSources=t||[],this}return this.cancelSources=[],this}cancel(){return this.cancelSources.forEach((({source:e})=>e&&e.cancel())),this.removeCancelSource(),this}};

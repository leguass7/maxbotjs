"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("axios"),t=require("camelcase-keys");function _interopDefaultLegacy(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var r=_interopDefaultLegacy(e),n=_interopDefaultLegacy(t);async function onResponseError(e){const t=e&&e.response,r=t&&parseInt(t.status,10),n={status:0,msg:"Timeout",response:t&&t.data||!1};return t?(n.msg=`httpError ${r}`,Promise.resolve(n)):Promise.resolve(n)}function prepareSendFilter(e){const{externalId:t,whatsapp:r,brCpf:n}=e,s={};if(t)s.ctExternalId=t;else if(r)s.ctWhatsapp=r;else{if(!n)return!1;s.ctBrCpf=n}return s}function normalizeContactSegmentation(e){return e&&Array.isArray(e)?e.filter((e=>!!e)).join(","):e}function isObject(e){return!("object"!=typeof e||null===e||e instanceof RegExp||e instanceof Error||e instanceof Date||Array.isArray(e))}function replaceAll(e,t,r){if(!e)return"";if(Array.isArray(t)){let n=`${e}`;for(let e=0;e<t.length;e++)n=replaceAll(n,t[e],r);return n}return e.split(`${t}`).join(r)}function extractExtension(e){return replaceAll((e=e.substr(1+e.lastIndexOf("/")).split("?")[0]).split("#")[0].substr(e.lastIndexOf(".")),".","")}function isValidURL(e){try{if(null!==e.match(/(http(s)?:\/\/.)?(www\.)?[-a-zA-Z0-9@:%._\+~#=]{2,256}\.[a-z]{2,6}\b([-a-zA-Z0-9@:%_\+.~#?&//=]*)/g)){const t=new URL(e);return!("http:"!==t.protocol&&"https:"!==t.protocol)}return!1}catch{return!1}}function decamelcaseStr(e,t="_"){return"string"==typeof e?e.replace(/([\p{Lowercase_Letter}\d])(\p{Uppercase_Letter})/gu,`$1${t}$2`).replace(/(\p{Uppercase_Letter}+)(\p{Uppercase_Letter}\p{Lowercase_Letter}+)/gu,`$1${t}$2`).toLowerCase():e}function mapObject(e){const t={};return Object.keys(e).forEach((r=>{const n=decamelcaseStr(r);t[n]=isObject(e[r])?mapObject(e[r]):e[r]})),t}function decamelcase(e){return Array.isArray(e)?e.map((e=>decamelcase(e))):isObject(e)?mapObject(e):decamelcaseStr(`${e}`)}const s="get_status",i="get_segmentation",a="get_template",o="get_service_sector",c="get_attendant",u="get_contact",l="get_prot",p="put_contact",d="set_contact",h="open_followup",f="send_text",g="send_image",m="send_file",y="send_sound";exports.default=class Maxbot{constructor(e){return this.config={token:"",timeout:3e3,baseURL:"https://mbr.maxbot.com.br/api/v1.php",debug:!1},this.ready=!1,this.loggingPrefix="MaxbotJs",this.version="0.1.7",this.Api=r.default.create(),this.cancelSources=[],this.allowedExt={file:["pdf","doc","docx","xls","xlsx","ppt","pptx","pps"],image:["jpg","jpeg","png","gif"],sound:["mp3"]},this.setMe(e).configureAxios()}log(...e){this.config.debug&&console.log(this.loggingPrefix,...e,"\n")}getCancelToken(){return r.default.CancelToken}configureAxios(){return this.Api=r.default.create({baseURL:this.config.baseURL}),this.configureRequests().configureResponses()}configureRequests(){return this.Api.interceptors.request.use((e=>(e.headers["user-agent"]=`maxbotjs/${this.version} (+https://github.com/leguass7/maxbotjs.git)`,e.data=decamelcase(e.data),this.log("REQUEST:",e.data),e))),this}configureResponses(){return this.Api.interceptors.response.use((e=>(this.log("RESPONSE:",e.data||e),n.default(e.data,{deep:!0}))),onResponseError),this}addError(e){return{status:0,msg:e}}isValidExt(e,t=""){const r=replaceAll(e,".","");if(!t){return Object.keys(this.allowedExt).reduce(((e,t)=>(this.allowedExt[t].forEach((t=>e.push(t))),e)),[]).includes(replaceAll(r,".",""))}return!!this.allowedExt[t].includes(replaceAll(r,".",""))}async isReady(e=!1){if(!this.config.token)return!1;return!e&&this.ready||(this.ready=await(async()=>{try{const e=await this.getStatus();return!(!e||!e.status)}catch(e){return!1}})()),!!this.ready}setMe(e,t){const{config:r}=this;if("object"==typeof e){const t=Object.keys(e);for(let n=0;n<t.length;n++)t[n]in r&&(r[t[n]]=e[t[n]])}else"string"==typeof e&&e in r&&(r[e]="function"==typeof t?t():t);return this}getMe(){return this.config}async getStatus(){return await this.requestApi(s)}async getSegmentation(){return await this.requestApi(i)}async getTemplate(){return await this.requestApi(a)}async getServiceSector(){return await this.requestApi(o)}async getAttendant(){return await this.requestApi(c)}async getContact(e){return await this.requestApi(u,e)}async getProt(e){return await this.requestApi(l,e)}async putContact(e){e.segmentation&&(e.segmentation=normalizeContactSegmentation(e.segmentation));return await this.requestApi(p,e)}async setContact(e){e.segmentation&&(e.segmentation=normalizeContactSegmentation(e.segmentation));return await this.requestApi(d,e)}async openFollowup(e){return await this.requestApi(h,e)}async sendText(e,t){const r=prepareSendFilter(e);if(!r)return!1;const n={...r,msg:t};return await this.requestApi(f,n)}async sendImage(e,t){const r=prepareSendFilter(e);if(!r)return this.addError("internal: no contact");if(!isValidURL(t))return this.addError("internal: invalid url");const n=extractExtension(t);if(!this.isValidExt(n,"image"))return this.addError(`internal: invalid extension ${n}`);const s={...r,imageUrl:t,imageExtension:n};return await this.requestApi(g,s)}async sendFile(e,t){const r=prepareSendFilter(e);if(!r)return this.addError("internal: no contact");if(!isValidURL(t))return this.addError("internal: invalid url");const n=extractExtension(t);if(!this.isValidExt(n,"file"))return this.addError(`internal: invalid extension ${n}`);const s={...r,fileUrl:t,fileExtension:n};return await this.requestApi(m,s)}async sendSound(e,t){const r=prepareSendFilter(e);if(!r)return this.addError("internal: no contact");if(!isValidURL(t))return this.addError("internal: invalid url");const n=extractExtension(t);if(!this.isValidExt(n,"sound"))return this.addError(`internal: invalid extension ${n}`);const s={...r,soundUrl:t,soundExtension:n};return await this.requestApi(y,s)}async requestApi(e,t={}){const r=this.getCancelToken().source(),n=r.token;this.addCancelSource(r);const s=await this.Api.post(null,{cmd:e,token:this.config.token,...t},{timeout:this.config.timeout,cancelToken:n});return this.removeCancelSource(n),s}addCancelSource(e){return this.cancelSources.push({idToken:e.token,source:e}),this}removeCancelSource(e){if(e){const t=this.cancelSources.filter((({idToken:t})=>t!==e));return this.cancelSources=t||[],this}return this.cancelSources=[],this}cancel(){return this.cancelSources.forEach((({source:e})=>e&&e.cancel())),this.removeCancelSource(),this}};
